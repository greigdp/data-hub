\documentclass[11pt, a4paper, oneside, english]{scrbook}

\usepackage[english]{babel}
\usepackage{blindtext}

% Set fonts.
\usepackage{fontspec,xltxtra,xunicode}
\defaultfontfeatures{Mapping=tex-text}
\setromanfont[Scale=MatchLowercase, Mapping=tex-text]{Alegreya}
\setsansfont[Scale=MatchLowercase, Mapping=tex-text]{Candela Book}
\setmonofont[Scale=MatchLowercase]{Menlo}

% Set Margins for pdf copy.
\usepackage[left=7em, right=21em, top=6.5em, bottom=11em]{geometry}

% Set text ragged right.
\usepackage{ragged2e}
\RaggedRight

% Prevent over-eager hypenation.
\hyphenpenalty=5000
\tolerance=1000

% Set Line spacing.
\usepackage{setspace}
\onehalfspacing

% Set paragraph indents to 1.5 em.
\setlength{\parindent}{1.5em}

% No space between paragraphs.
\setlength{\parskip}{0ex}

% No bold headings.
\usepackage{sectsty}
\allsectionsfont{\mdseries}

% Set page numbers and tweak pages at the start of chapters.
% NB: fancyhdr *has* to load after the geometry package!
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyfoot[R]{\thepage}
\fancypagestyle{plain}{\fancyfoot[R]{\thepage}}

% Force width of header rule to zero.
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

% Colours
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\definecolor{light-grey}{gray}{0.80}

% Set code listings with the correct spacing
\newcommand{\lstsinglespacing}{
  \setstretch{1.1}
}
\usepackage{listings}
\lstset{basicstyle=\lstsinglespacing\footnotesize\ttfamily,
        showstringspaces=false,
        keepspaces=true,
        tabsize=2,
        commentstyle=\color{gray},
        captionpos=t,
        belowcaptionskip=1.5ex,
        frame=lines,
        numbers=left,
        numberstyle=\footnotesize\ttfamily\color{light-grey},
        numbersep=1em}

% remove default keywords for XML and highlight HTML style comments.
% [Fix;me: add Android-specific syntax highlighting.]
\lstdefinelanguage{XML}
{
  language=html,
  basicstyle=\lstsinglespacing\footnotesize\ttfamily,
  morestring=[b]",
  morecomment=[s]{<?}{?>},
  morecomment=[s][\color{gray}]{<!--}{-->},
  keywordstyle=\normalfont\ttfamily
}

% Captions left justified
\usepackage[format=plain,
            labelsep=newline,
            singlelinecheck=false,
            justification=raggedright,
            font={footnotesize, normalfont},
            labelfont={footnotesize, normalfont}
           ]{caption}

% ************************************************************************* %

\begin{document}
\chapter{Code Listings} % (fold)
\label{cha:code_listings}
[Fix;me: Intro to code listings.]
\section{Android App} % (fold)
\label{sec:android_app}
[Fix;me: Overview of Android app code.]
\newpage
\lstinputlisting[language=XML,
                 caption=\ttfamily{AndroidManifest.xml},
                 label=lab:AndroidManifestxml,
                ]{../AndroidManifest.xml}
\newpage
\lstinputlisting[language=Java,
                 caption=\ttfamily{Hub.java},
                 label=lab:Hubjava
                ]{../src/com/strath/hub/Hub.java}
\newpage
\lstinputlisting[language=Java,
                 caption=\ttfamily{BluetoothLinkService.java},
                 label=lab:BluetoothLinkServicejava,
                ]{../src/com/strath/hub/BluetoothLinkService.java}
\newpage
\lstinputlisting[language=XML,
                 caption=\ttfamily{main.xml},
                 label=lab:mainxml,
                ]{../res/layout/main.xml}
\lstinputlisting[language=XML,
                 caption=\ttfamily{styles.xml},
                 label=lab:stylesxml,
                ]{../res/values/styles.xml}
\lstinputlisting[language=XML,
                 caption=\ttfamily{strings.xml},
                 label=lab:stringsxml,
                ]{../res/values/strings.xml}
% section android_app (end)
% chapter code_listings (end)
\end{document}
