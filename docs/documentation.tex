\documentclass[11pt, a4paper, oneside, english]{scrbook}

\usepackage[english]{babel}
\usepackage{blindtext}

% Set fonts.
\usepackage{fontspec,xltxtra,xunicode}
\defaultfontfeatures{Mapping=tex-text}
\setromanfont[Scale=MatchLowercase, Mapping=tex-text]{Alegreya}
\setsansfont[Scale=MatchLowercase, Mapping=tex-text]{Candela Book}
\setmonofont[Scale=MatchLowercase]{Menlo}

% Set Margins for pdf copy.
\usepackage[left=7em, right=21em, top=6.5em, bottom=11em]{geometry}

% Set text ragged right.
\usepackage{ragged2e}
\RaggedRight

% Prevent over-eager hypenation.
\hyphenpenalty=5000
\tolerance=1000

% Set Line spacing.
\usepackage{setspace}
\setstretch{1.1} % Spaces Alegreya nicely

% Set paragraph indents to 1.5 em.
\setlength{\parindent}{1em}

% No space between paragraphs.
\setlength{\parskip}{0ex}

% No bold headings.
\usepackage{sectsty}
\allsectionsfont{\mdseries}

% Set page numbers and tweak pages at the start of chapters.
% NB: fancyhdr *has* to load after the geometry package!
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyfoot[R]{\thepage}
\fancypagestyle{plain}{\fancyfoot[R]{\thepage}}

% Force width of header rule to zero.
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

% Colours
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\definecolor{light-grey}{gray}{0.80}

% Set code listings with the correct spacing
\newcommand{\lstsinglespacing}{
  \setstretch{0.95} % Tighten up Menlo line spacing
}
\usepackage{listings}
\lstset{basicstyle=\lstsinglespacing\footnotesize\ttfamily,
        showstringspaces=false,
        keepspaces=true,
        tabsize=2,
        commentstyle=\color{gray},
        captionpos=t,
        belowcaptionskip=1.5ex,
        frame=lines,
        numbers=left,
        numberstyle=\footnotesize\ttfamily\color{light-grey},
        numbersep=1em}

% remove default keywords for XML and highlight HTML style comments.
% [Fix;me: add Android-specific syntax highlighting.]
\lstdefinelanguage{XML}
{
  language=html,
  basicstyle=\lstsinglespacing\footnotesize\ttfamily,
  morestring=[b]",
  morecomment=[s]{<?}{?>},
  morecomment=[s][\color{gray}]{<!--}{-->},
  keywordstyle=\normalfont\ttfamily
}

% Captions left justified
\usepackage[format=plain,
            labelsep=newline,
            singlelinecheck=false,
            justification=raggedright,
            font={normalsize, normalfont},
            labelfont={normalsize, bf}
           ]{caption}


% ************************************************************************* %

\begin{document}
\chapter{Data Hub: The Android App} % (fold)
\label{cha:data_hub}
[Fix;me: Intro to Android app. Main activity\lstinline{Hub.java}. Class to set up and manage Bluetooth connections\lstinline{BluetoothLinkService.java}.]
\section{Receiving Bluetooth Data} % (fold)
\label{sec:receiving_bluetooth_data}
[Fix;me: add an overview of the section here and/or remove the following subsection heading.]
\subsection{Initialising a Connection} % (fold)
\label{sub:initialising_a_connection}
Before initialising a connection some requirements must be satisfied in order that the app is able to receive data over the Bluetooth. The first is that the MAC address of the slave device sending the data must be known. Therefore the MAC address is hard coded as the constant\lstinline{MAC_ADDRESS} in the main activity of the app. In the example shown in this documentation the MAC address of the test embedded system is 00:12:06:82:84 [Fix;me: update MAC address]. Future iterations of the design of the app should allow this parameter to be configurable. Details of how this might be achieved without risking losing connectivity, and therefore data, are given in Section~\ref{sec:configurable_bluetooth_mac_adress}.

Secondly, before attempting to set up a Bluetooth connection, the app must establish that the device on which it is installed can support Bluetooth and that it has been enabled. Both of these tasks are performed in the\lstinline{onCreate} lifecycle callback method. If Bluetooth is not supported the user is alerted using a toast message and the app stops running. If the local Bluetooth adapter is available it is enabled---if it is not already---by prompting the user to do so. The app is now ready to attempt to create a connection. 

\begin{lstlisting}[language=Java,
                   numbers=none]
@Override
public void onCreate(Bundle savedInstanceState)
{
  // ...

  mBluetoothAdapter = BluetoothAdapter.getDefaultAdapter();
  if (mBluetoothAdapter == null)
  {
    Toast.makeText(this,
                   "Bluetooth is not supported",
                   Toast.LENGTH_LONG).show();
    finish();
    return;
  }
  else
  {

    if (!mBluetoothAdapter.isEnabled())
      Intent enableIntent = new Intent(BluetoothAdapter.
                                       ACTION_REQUEST_ENABLE);
    else
      // Set up the link session.
  }
}
\end{lstlisting}
The main activity of the app uses two methods to initiate a connection:\lstinline{setupLink()} and\lstinline{connectDevice()}. Each performs a simple function. A new instance of\lstinline{BluetoothLinkService} is created when\lstinline{setupLink()} is called. Then, when\lstinline{connectDevice()} is called, a\lstinline{BluetoothDevice} object representing the slave device is instantiated using\lstinline{MAC_ADDRESS} which is passed as an argument in a call of the\lstinline{connect()} method to the\lstinline{BluetoothLinkService} instance created in\lstinline{setupLink()}.
\begin{lstlisting}[language=Java,
                   numbers=none]
pivate void setupLink()
{ 
  mLinkService = new BluetoothLinkService(this, mHandler);
}

private void connectDevice()
{
  BluetoothDevice device = mBluetoothAdapter.getRemoteDevice(MAC_ADDRESS);
  mLinkService.connect(device);
}
\end{lstlisting}
% subsection initiiate_a_connection (end)
\subsection{The\lstinline{BluetoothLinkService} Class} % (fold)
\label{sub:bls}
A\lstinline{BluetoothLinkService} is created by passing an application context and handler to the constructor.
\begin{lstlisting}[language=Java,
                   numbers=none]
public BluetoothLinkService(Context context, Handler handler)
{
  mContext = context;
  mHandler = handler;
  mAdapter = BluetoothAdapter.getDefaultAdapter();
  // ...
}
\end{lstlisting}
When the constructor is called in\lstinline{Hub.java} (see\lstinline{setupLink()}) the\lstinline{this} keyword is used to pass the pass the context of the main activity, and a new handler is created to receive messages sent from the threads used by the\lstinline{BluetoothLinkService}. A\lstinline{BluetoothAdapter} is also instantiated to represent the default adapter of the device.

\texttt{mHandler} is primarily used to update the user interface on changes in status of the Bluetooth connection and is discussed in detail in Sub-section~\ref{sec:the_user_interface}. The remainder of this Sub-section details the operation of\lstinline{BluetoothLinkService} class.

The\lstinline{BluetoothLinkService} class sets up and manages Bluetooth connections. It uses two separate threads to connect to devices, and when connected, to receive data. These threads are controlled by three methods:
\begin{enumerate}
\item\lstinline{connect()} to initiate a connection to a remote (slave) device,
\item\lstinline{connected()} to manage a\lstinline{BluetoothLinkService} which is running a\lstinline{ConnectedThread}, and
\item\lstinline{stop()} to stop all threads running as part of a\lstinline{BluetoothLinkService}.
\end{enumerate}
The\lstinline{connect()} method closes any open connections, including those currently connecting, and then creates a new\lstinline{ConnectThread} to establish a connection. When called\lstinline{ConnectThread} instantiates a local\lstinline{BluetoothSocket} using the default secure serial port protocol UUID, and a\lstinline{BluetoothDevice} using the parameter passed to the\lstinline{connect()} method. If this is successful the thread runs.

Before trying to connect, any service discovery which is running on the adapter is cancelled to prevent it from slowing the connection. The\lstinline{connect()} method is then called on the socket. If a connection is established successfully, the thread is reset and the\lstinline{connected()} method is called. The connection is now established.
\begin{lstlisting}[language=Java,
                   numbers=none]
public synchronized void connect(BluetoothDevice device)
{
  // ...
  mConnectThread = new ConnectThread(device);
  mConnectThread.start();
  // ...  
}

private class ConnectThread extends Thread
  {
    private final BluetoothSocket mSocket;
    private final BluetoothDevice mDevice;

    public ConnectThread(BluetoothDevice device)
    {
      mDevice = device;
      BluetoothSocket tmp = null;

      try
      {
        tmp = device.createRfcommSocketToServiceRecord(SECURE_UUID);
      }
      catch (IOException e)
      {
        Log.e(TAG, "Failed to create socket.\n", e);
      }
      mSocket = tmp;
    }

    public void run()
    {
      mAdapter.cancelDiscovery();

      try
      {
        if (Debug) Log.i(TAG, "Trying to connect.");
        mSocket.connect();
      }
      catch (IOException e)
      {
        // ...
      }

      synchronized (BluetoothLinkService.this)
      {
        mConnectThread = null;
      }

      connected(mSocket, mDevice);
    }

    // cancel()
  }
\end{lstlisting}
The\lstinline{connected()} method creates a new\lstinline{ConnectedThread} and starts it. The\lstinline{ConnectedThread} creates a local\lstinline{BluetoothSocket} from the instance passed as an argument also creates a local\lstinline{InputStream}. If an\lstinline{InputStream} is available form the socket the thread runs.

\lstinline{ConnectedThread} continually listens to the\lstinline{InputStream} while connected. A\lstinline{BufferedReader} is created and each array of bytes sent over the Bluetooth connection is read into it using an\lstinline{InputStreamReader}. Any data in the\lstinline{BufferedReader} it is parsed, sent to the user interface for display and stored locally on the device.
\begin{lstlisting}[language=Java,
                   numbers=none]
  public synchronized void connected(BluetoothSocket socket,
                                     BluetoothDevice device)
  {
    // Cancel any threads already running here.

    mConnectedThread = new ConnectedThread(socket);
    mConnectedThread.start();

    // ...
  }

  private class ConnectedThread extends Thread
  {
    private final BluetoothSocket mSocket;
    private final InputStream mInStream;  

    public ConnectedThread(BluetoothSocket socket)
    {
      mSocket = socket;
      InputStream tmpIn = null;  

      try
      {
        tmpIn = socket.getInputStream();
      }
      catch (IOException e)
      {
        // ...
      }  

      mInStream = tmpIn;
    }

    public void run()
    {
      while (true)
      {
        try
        {
          BufferedReader reader = new BufferedReader(
            new InputStreamReader(mInStream));
          String line;  

          while ((line = reader.readLine()) != null)
          {
            // Save data to DB and send to UI.
          }
        }
        catch (IOException e)
        {
          // ...
        }
      }
    }

    // cancel()
  }
\end{lstlisting}
% subsection bluetoothlinkservice (end)
% section receiving_bluetooth_data (end)
\section{Gathering Location Data} % (fold)
\label{sec:gathering_location_data}
[Fix;Me: fold in location gathering code and test.]
% section gathering_location_data (end)
\section{The User Interface} % (fold)
\label{sec:the_user_interface}
[Fix;Me: document the\lstinline{Handler} in\lstinline{Hub.java}.]
% section the_user_interface (end)
\section{Storing Data Locally} % (fold)
\label{sec:storing_data_locally}
[Fix;me: document parsing Bluetooth input stream here?]
% section storing_data_locally (end)
\section{Storing Data Remotely} % (fold)
\label{sec:storing_data_remotely}

% section storing_data_remotely (end)
% chapter data_hub (end)
\chapter{Testing} % (fold)
\label{cha:testing}
\section{Accelerometer Data} % (fold)
\label{sec:accelerometer_data}
[Fix;Me: basic ``12 point'' test. Discuss calibration in Section~\ref{sec:calibration}.]
% section accelerometer_data (end)
\section{Receiving and Storing Data} % (fold)
\label{sec:receiving_data}

% section receiving and storing_data (end)
\section{Syncing Stored Data with a Server} % (fold)
\label{sec:syncing_stored_data_with_a_server}

% section syncing_stored_data_with_a_server (end)
% chapter testing (end)
\chapter{Further Work} % (fold)
\label{cha:further_work}
\section{Configurable Bluetooth MAC Address} % (fold)
\label{sec:configurable_bluetooth_mac_adress}
[Fix;Me: Clinicians should be able to pair an app/patient with a specific embedded system. More complex than a added a menu because we don't want patients to be able to alter the settings.]
% section configurable_bluetooth_mac_adress (end)
\section{Calibration} % (fold)
\label{sec:calibration}
[Fix;me: there are two problems which must be solved:
\begin{enumerate}
\item establishing the differences between the reference frame of the accelerometer, the embedded system, and the prosthesis for any given measurement, (All three could move.), and
\item recalibrating the accelerometer to account for drift, possibly with a ``quasi-static movements detector''.
\end{enumerate}]
% section calibration (end)
% chapter further_work (end)
\chapter{Code Listings} % (fold)
\label{cha:code_listings}
[Fix;me: Intro to code listings.]
\section{Android App} % (fold)
\label{sec:android_app}
[Fix;me: Overview of Android app code.]
\lstinputlisting[language=XML,
                 caption=\ttfamily{AndroidManifest.xml},
                 label=lst:AndroidManifestxml,
                ]{../AndroidManifest.xml}
\newpage
\lstinputlisting[language=Java,
                 caption=\ttfamily{Hub.java},
                 label=lst:Hubjava
                ]{../src/com/strath/hub/Hub.java}
\newpage
\lstinputlisting[language=Java,
                 caption=\ttfamily{BluetoothLinkService.java},
                 label=lst:BluetoothLinkServicejava,
                ]{../src/com/strath/hub/BluetoothLinkService.java}
\newpage
\lstinputlisting[language=XML,
                 caption=\ttfamily{main.xml},
                 label=lst:mainxml,
                ]{../res/layout/main.xml}
\lstinputlisting[language=XML,
                 caption=\ttfamily{styles.xml},
                 label=lst:stylesxml,
                ]{../res/values/styles.xml}
\lstinputlisting[language=XML,
                 caption=\ttfamily{strings.xml},
                 label=lst:stringsxml,
                ]{../res/values/strings.xml}
% section android_app (end)
% chapter code_listings (end)
\end{document}
